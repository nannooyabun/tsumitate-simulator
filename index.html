<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©ç«‹æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 16px;
    }
    
    .phone-frame {
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 16px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    .content {
      padding: 16px;
    }
    
    .section {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 14px;
      background: #667eea;
      border-radius: 2px;
    }
    
    /* éŠ˜æŸ„é¸æŠ */
    .fund-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    .fund-btn {
      padding: 12px 6px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fff;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .fund-btn.active {
      border-color: #667eea;
      background: #f0f3ff;
    }
    
    .fund-btn .icon {
      font-size: 22px;
      margin-bottom: 4px;
    }
    
    .fund-btn .name {
      font-size: 10px;
      font-weight: 600;
      color: #333;
    }
    
    .fund-btn .subtext {
      font-size: 8px;
      color: #999;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šå…¥åŠ› */
    .custom-rate-container {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 12px;
      display: none;
    }
    
    .custom-rate-container.show {
      display: block;
    }
    
    .custom-rate-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .custom-rate-label {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    
    .custom-rate-input-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 12px;
    }
    
    .custom-rate-input-wrap:focus-within {
      border-color: #667eea;
    }
    
    .custom-rate-input {
      flex: 1;
      border: none;
      font-size: 18px;
      font-weight: 600;
      text-align: right;
      outline: none;
      width: 60px;
    }
    
    .custom-rate-unit {
      font-size: 14px;
      color: #666;
      margin-left: 4px;
    }
    
    .custom-rate-presets {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    
    .rate-preset-btn {
      flex: 1;
      padding: 6px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fff;
      font-size: 11px;
      color: #666;
      cursor: pointer;
    }
    
    .rate-preset-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }
    
    /* æœŸé–“é¸æŠ */
    .period-selector {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .period-picker {
      flex: 1;
    }
    
    .period-picker-label {
      font-size: 11px;
      color: #999;
      margin-bottom: 6px;
    }
    
    .period-picker-inputs {
      display: flex;
      gap: 6px;
    }
    
    .period-select {
      flex: 1;
      padding: 10px 4px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      background: #fff;
      cursor: pointer;
      text-align: center;
    }
    
    .period-select:focus {
      border-color: #667eea;
      outline: none;
    }
    
    .period-arrow {
      color: #667eea;
      font-size: 20px;
      padding-bottom: 10px;
    }
    
    .period-summary {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    
    .period-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    /* ä¾¡æ ¼æ¨ç§»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .price-preview {
      margin-top: 16px;
      background: #fff;
      border: 2px solid #e8ecf0;
      border-radius: 12px;
      padding: 12px;
    }
    
    .price-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .price-preview-title {
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }
    
    .price-preview-range {
      font-size: 10px;
      color: #999;
    }
    
    .price-preview-chart {
      height: 120px;
      margin-bottom: 8px;
    }
    
    .price-preview-chart canvas {
      max-height: 120px;
    }
    
    .price-preview-stats {
      display: flex;
      justify-content: space-around;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 8px;
    }
    
    .preview-stat {
      text-align: center;
    }
    
    .preview-stat-label {
      display: block;
      font-size: 10px;
      color: #999;
    }
    
    .preview-stat-value {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    
    .preview-stat-value.positive {
      color: #4caf50;
    }
    
    .preview-stat-value.negative {
      color: #f44336;
    }
    
    /* é‡‘é¡å…¥åŠ› */
    .amount-input-container {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 8px 16px;
      gap: 8px;
    }
    
    .amount-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 600;
      text-align: right;
      outline: none;
      width: 100%;
    }
    
    .amount-unit {
      font-size: 16px;
      color: #666;
    }
    
    .amount-presets {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .preset-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      font-size: 12px;
      color: #666;
      cursor: pointer;
    }
    
    .preset-btn:hover, .preset-btn.active {
      border-color: #667eea;
      color: #667eea;
      background: #f0f3ff;
    }
    
    /* è¨¼åˆ¸ä¼šç¤¾é¸æŠ */
    .broker-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .broker-btn {
      padding: 10px 8px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: #fff;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .broker-btn.active {
      border-color: #667eea;
      background: #f0f3ff;
    }
    
    .broker-btn .name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
    }
    
    .broker-btn .rate {
      font-size: 9px;
      color: #667eea;
      margin-top: 2px;
    }
    
    /* ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .simulate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .simulate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .simulate-btn:active {
      transform: translateY(0);
    }
    
    .simulate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .results {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 16px;
      display: none;
    }
    
    .results.show {
      display: block;
    }
    
    .results-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .comparison {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .comparison-card {
      flex: 1;
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      border: 2px solid transparent;
    }
    
    .comparison-card.winner {
      border-color: #667eea;
    }
    
    .comparison-card .label {
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
    }
    
    .comparison-card .amount {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }
    
    .comparison-card.winner .amount {
      color: #667eea;
    }
    
    .comparison-card .diff {
      font-size: 11px;
      margin-top: 4px;
    }
    
    .comparison-card .diff.positive {
      color: #4caf50;
    }
    
    .comparison-card .diff.negative {
      color: #f44336;
    }
    
    .comparison-card .principal {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    
    /* ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */
    .points-display {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .points-icon {
      font-size: 20px;
    }
    
    .points-info {
      flex: 1;
    }
    
    .points-label {
      font-size: 10px;
      color: #996633;
    }
    
    .points-value {
      font-size: 16px;
      font-weight: 700;
      color: #cc6600;
    }
    
    /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
    .chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .chart-container canvas {
      max-height: 200px;
    }
    
    /* å‡¡ä¾‹ */
    .legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #666;
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .legend-dot.tsumitate {
      background: #667eea;
    }
    
    .legend-dot.ikkatsu {
      background: #e0e0e0;
    }
    
    /* è³¼å…¥å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .purchase-history {
      margin-top: 16px;
    }
    
    .history-accordion {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .history-header:hover {
      background: #f8f9fa;
    }
    
    .history-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .history-icon {
      font-size: 18px;
    }
    
    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    
    .history-arrow {
      font-size: 12px;
      color: #999;
      transition: transform 0.3s;
    }
    
    .history-accordion.open .history-arrow {
      transform: rotate(180deg);
    }
    
    .history-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .history-accordion.open .history-content {
      max-height: 500px;
    }
    
    .history-inner {
      padding: 0 14px 14px;
    }
    
    /* ä¸€æ‹¬æŠ•è³‡ã®è©³ç´° */
    .ikkatsu-detail {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
    }
    
    .ikkatsu-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .ikkatsu-row:last-child {
      margin-bottom: 0;
    }
    
    .ikkatsu-label {
      font-size: 12px;
      color: #666;
    }
    
    .ikkatsu-value {
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }
    
    /* ç©ç«‹æŠ•è³‡ã®è³¼å…¥å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« */
    .tsumitate-table-container {
      max-height: 250px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .tsumitate-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    .tsumitate-table thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
    }
    
    .tsumitate-table th {
      padding: 8px 6px;
      text-align: center;
      font-weight: 600;
      color: #666;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tsumitate-table td {
      padding: 8px 6px;
      text-align: center;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .tsumitate-table tr:last-child td {
      border-bottom: none;
    }
    
    .tsumitate-table .highlight {
      background: #e8f5e9;
    }
    
    .tsumitate-table .highlight td {
      color: #2e7d32;
    }
    
    /* å¹³å‡å–å¾—å˜ä¾¡ã‚µãƒãƒªãƒ¼ */
    .avg-cost-summary {
      display: flex;
      justify-content: space-between;
      background: #e8f0fe;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 10px;
    }
    
    .avg-cost-item {
      text-align: center;
    }
    
    .avg-cost-label {
      font-size: 10px;
      color: #5c6bc0;
    }
    
    .avg-cost-value {
      font-size: 14px;
      font-weight: 700;
      color: #3949ab;
    }
    
    /* æ³¨é‡ˆ */
    .note {
      margin-top: 16px;
      padding: 12px;
      background: #fff3e0;
      border-radius: 8px;
      font-size: 10px;
      color: #e65100;
      line-height: 1.5;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="phone-frame">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>ğŸ’° ç©ç«‹æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p>ãƒ‰ãƒ«ã‚³ã‚¹ãƒˆå¹³å‡æ³•ã®åŠ¹æœã‚’ä½“é¨“ã—ã‚ˆã†</p>
    </div>
    
    <div class="content">
      <!-- éŠ˜æŸ„é¸æŠ -->
      <div class="section">
        <div class="section-title">æŠ•è³‡å…ˆã‚’é¸ã¶</div>
        <div class="fund-selector">
          <div class="fund-btn active" data-fund="acwi">
            <div class="icon">ğŸŒ</div>
            <div class="name">ã‚ªãƒ«ã‚«ãƒ³</div>
            <div class="subtext">å…¨ä¸–ç•Œæ ªå¼</div>
          </div>
          <div class="fund-btn" data-fund="fang">
            <div class="icon">ğŸš€</div>
            <div class="name">FANG+</div>
            <div class="subtext">ç±³ãƒ†ãƒƒã‚¯10ç¤¾</div>
          </div>
          <div class="fund-btn" data-fund="nikkei">
            <div class="icon">ğŸ—¾</div>
            <div class="name">æ—¥çµŒå¹³å‡</div>
            <div class="subtext">æ—¥æœ¬225ç¤¾</div>
          </div>
          <div class="fund-btn" data-fund="custom">
            <div class="icon">âš™ï¸</div>
            <div class="name">ã‚«ã‚¹ã‚¿ãƒ </div>
            <div class="subtext">åˆ©å›ã‚ŠæŒ‡å®š</div>
          </div>
        </div>
        
        <!-- ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šå…¥åŠ› -->
        <div class="custom-rate-container" id="customRateContainer">
          <div class="custom-rate-row">
            <span class="custom-rate-label">æƒ³å®šå¹´åˆ©å›ã‚Š</span>
            <div class="custom-rate-input-wrap">
              <input type="number" class="custom-rate-input" id="customRate" value="5.0" step="0.1" min="0" max="50">
              <span class="custom-rate-unit">%</span>
            </div>
          </div>
          <div class="custom-rate-presets">
            <button class="rate-preset-btn" data-rate="3">3%</button>
            <button class="rate-preset-btn" data-rate="5">5%</button>
            <button class="rate-preset-btn" data-rate="7">7%</button>
            <button class="rate-preset-btn" data-rate="10">10%</button>
          </div>
        </div>
      </div>
      
      <!-- æŠ•è³‡æœŸé–“ -->
      <div class="section">
        <div class="section-title">æŠ•è³‡æœŸé–“</div>
        <div class="period-selector">
          <div class="period-picker">
            <div class="period-picker-label">é–‹å§‹</div>
            <div class="period-picker-inputs">
              <select class="period-select" id="startYear"></select>
              <select class="period-select" id="startMonth"></select>
            </div>
          </div>
          
          <div class="period-arrow">â†’</div>
          
          <div class="period-picker">
            <div class="period-picker-label">çµ‚äº†</div>
            <div class="period-picker-inputs">
              <select class="period-select" id="endYear"></select>
              <select class="period-select" id="endMonth"></select>
            </div>
          </div>
        </div>
        
        <div class="period-summary">
          <div class="period-badge" id="periodBadge">ğŸ“… æŠ•è³‡æœŸé–“ï¼š10å¹´0ãƒ¶æœˆ</div>
        </div>
        
        <!-- ä¾¡æ ¼æ¨ç§»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="price-preview" id="pricePreview">
          <div class="price-preview-header">
            <span class="price-preview-title" id="previewTitle">ğŸ“ˆ ã‚ªãƒ«ã‚«ãƒ³ ä¾¡æ ¼æ¨ç§»</span>
            <span class="price-preview-range" id="previewRange"></span>
          </div>
          <div class="price-preview-chart">
            <canvas id="pricePreviewChart"></canvas>
          </div>
          <div class="price-preview-stats">
            <div class="preview-stat">
              <span class="preview-stat-label">é–‹å§‹æ™‚</span>
              <span class="preview-stat-value" id="previewStartPrice">-</span>
            </div>
            <div class="preview-stat">
              <span class="preview-stat-label">çµ‚äº†æ™‚</span>
              <span class="preview-stat-value" id="previewEndPrice">-</span>
            </div>
            <div class="preview-stat">
              <span class="preview-stat-label">å¤‰å‹•ç‡</span>
              <span class="preview-stat-value" id="previewChangeRate">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ¯æœˆã®ç©ç«‹é‡‘é¡ -->
      <div class="section">
        <div class="section-title">æ¯æœˆã®ç©ç«‹é‡‘é¡</div>
        <div class="amount-input-container">
          <input type="number" class="amount-input" id="monthlyAmount" value="30000" min="1000" step="1000">
          <span class="amount-unit">å††/æœˆ</span>
        </div>
        <div class="amount-presets">
          <button class="preset-btn" data-amount="10000">1ä¸‡å††</button>
          <button class="preset-btn active" data-amount="30000">3ä¸‡å††</button>
          <button class="preset-btn" data-amount="50000">5ä¸‡å††</button>
          <button class="preset-btn" data-amount="100000">10ä¸‡å††</button>
        </div>
      </div>
      
      <!-- è¨¼åˆ¸ä¼šç¤¾ -->
      <div class="section">
        <div class="section-title">è¨¼åˆ¸ä¼šç¤¾ï¼ˆãƒã‚¤ãƒ³ãƒˆé‚„å…ƒï¼‰</div>
        <div class="broker-selector">
          <div class="broker-btn" data-broker="none" data-card-rate="0" data-holding-rate="0">
            <div class="name">ãªã—</div>
            <div class="rate">0%</div>
          </div>
          <div class="broker-btn active" data-broker="sbi" data-card-rate="0.5" data-holding-rate="0.02">
            <div class="name">SBIè¨¼åˆ¸</div>
            <div class="rate">0.5%+ä¿æœ‰</div>
          </div>
          <div class="broker-btn" data-broker="rakuten" data-card-rate="0.5" data-holding-rate="0">
            <div class="name">æ¥½å¤©è¨¼åˆ¸</div>
            <div class="rate">0.5%</div>
          </div>
          <div class="broker-btn" data-broker="monex" data-card-rate="1.1" data-holding-rate="0.03">
            <div class="name">ãƒãƒãƒƒã‚¯ã‚¹</div>
            <div class="rate">1.1%+ä¿æœ‰</div>
          </div>
          <div class="broker-btn" data-broker="au" data-card-rate="1.0" data-holding-rate="0.02">
            <div class="name">auã‚«ãƒ–ã‚³ãƒ </div>
            <div class="rate">1%+ä¿æœ‰</div>
          </div>
          <div class="broker-btn" data-broker="custom" data-card-rate="0" data-holding-rate="0">
            <div class="name">ã‚«ã‚¹ã‚¿ãƒ </div>
            <div class="rate">è‡ªç”±å…¥åŠ›</div>
          </div>
        </div>
      </div>
      
      <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <button class="simulate-btn" id="simulateBtn">
        â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      </button>
      
      <!-- çµæœè¡¨ç¤º -->
      <div class="results" id="results">
        <div class="results-title">ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
        
        <!-- ä¸€æ‹¬ vs ç©ç«‹ æ¯”è¼ƒ -->
        <div class="comparison">
          <div class="comparison-card" id="ikkatsuCard">
            <div class="label">ä¸€æ‹¬æŠ•è³‡</div>
            <div class="amount" id="ikkatsuAmount">-</div>
            <div class="diff" id="ikkatsuDiff"></div>
            <div class="principal" id="ikkatsuPrincipal">å…ƒæœ¬ -</div>
          </div>
          <div class="comparison-card" id="tsumitateCard">
            <div class="label">ç©ç«‹æŠ•è³‡</div>
            <div class="amount" id="tsumitateAmount">-</div>
            <div class="diff" id="tsumitateDiff"></div>
            <div class="principal" id="tsumitatePrincipal">å…ƒæœ¬ -</div>
          </div>
        </div>
        
        <!-- ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º -->
        <div class="points-display">
          <div class="points-icon">ğŸ</div>
          <div class="points-info">
            <div class="points-label">ç²å¾—ãƒã‚¤ãƒ³ãƒˆï¼ˆç©ç«‹æœŸé–“ä¸­ï¼‰</div>
            <div class="points-value" id="totalPoints">- pt</div>
          </div>
        </div>
        
        <!-- ã‚°ãƒ©ãƒ• -->
        <div class="chart-container">
          <canvas id="resultChart"></canvas>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-dot tsumitate"></div>
              ç©ç«‹æŠ•è³‡
            </div>
            <div class="legend-item">
              <div class="legend-dot ikkatsu"></div>
              ä¸€æ‹¬æŠ•è³‡
            </div>
          </div>
        </div>
        
        <!-- è³¼å…¥å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="purchase-history">
          <!-- ä¸€æ‹¬æŠ•è³‡ã®è©³ç´° -->
          <div class="history-accordion" id="ikkatsuAccordion">
            <div class="history-header">
              <div class="history-header-left">
                <span class="history-icon">ğŸ’µ</span>
                <span class="history-title">ä¸€æ‹¬æŠ•è³‡ã®è³¼å…¥è©³ç´°</span>
              </div>
              <span class="history-arrow">â–¼</span>
            </div>
            <div class="history-content">
              <div class="history-inner">
                <div class="ikkatsu-detail" id="ikkatsuDetail">
                </div>
              </div>
            </div>
          </div>
          
          <!-- ç©ç«‹æŠ•è³‡ã®è©³ç´° -->
          <div class="history-accordion" id="tsumitateAccordion">
            <div class="history-header">
              <div class="history-header-left">
                <span class="history-icon">ğŸ“</span>
                <span class="history-title">ç©ç«‹æŠ•è³‡ã®è³¼å…¥å±¥æ­´</span>
              </div>
              <span class="history-arrow">â–¼</span>
            </div>
            <div class="history-content">
              <div class="history-inner">
                <div class="tsumitate-table-container">
                  <table class="tsumitate-table">
                    <thead>
                      <tr>
                        <th>å¹´æœˆ</th>
                        <th>ä¾¡æ ¼</th>
                        <th>è³¼å…¥å£æ•°</th>
                        <th>ç´¯è¨ˆå£æ•°</th>
                      </tr>
                    </thead>
                    <tbody id="tsumitateTableBody">
                    </tbody>
                  </table>
                </div>
                
                <!-- ã‚µãƒãƒªãƒ¼ -->
                <div class="avg-cost-summary">
                  <div class="avg-cost-item">
                    <div class="avg-cost-label">å¹³å‡å–å¾—å˜ä¾¡</div>
                    <div class="avg-cost-value" id="avgCost">-</div>
                  </div>
                  <div class="avg-cost-item">
                    <div class="avg-cost-label">åˆè¨ˆè³¼å…¥å£æ•°</div>
                    <div class="avg-cost-value" id="totalUnits">-</div>
                  </div>
                  <div class="avg-cost-item">
                    <div class="avg-cost-label">è³¼å…¥å›æ•°</div>
                    <div class="avg-cost-value" id="purchaseCount">-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ³¨é‡ˆ -->
      <div class="note">
        âš ï¸ ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯éå»ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå‚è€ƒå€¤ã§ã™ã€‚å°†æ¥ã®é‹ç”¨æˆæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šã¯ä¸€å®šã®å¹´åˆ©ã‚’æƒ³å®šã—ãŸç†è«–å€¤ã§ã™ã€‚ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒç‡ã¯2024å¹´æ™‚ç‚¹ã®æƒ…å ±ã§ã‚ã‚Šã€å®Ÿéš›ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç·‘è‰²ã®è¡Œã¯å¹³å‡ã‚ˆã‚Šå®‰ãå¤šãè²·ãˆãŸæœˆã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    let indexData = null;
    let chart = null;
    let previewChart = null;
    
    const fundNames = {
      acwi: 'ã‚ªãƒ«ã‚«ãƒ³',
      fang: 'FANG+',
      nikkei: 'æ—¥çµŒå¹³å‡',
      custom: 'ã‚«ã‚¹ã‚¿ãƒ '
    };
    
    // æ•°å€¤ã‚’è¦‹ã‚„ã™ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    function formatPrice(val) {
      if (val >= 1000000) {
        return 'Â¥' + (val / 10000).toFixed(0) + 'ä¸‡';
      } else if (val >= 10000) {
        return 'Â¥' + (val / 10000).toFixed(1) + 'ä¸‡';
      } else {
        return 'Â¥' + Math.round(val).toLocaleString();
      }
    }
    
    function formatPriceDetail(val) {
      return 'Â¥' + Math.round(val).toLocaleString();
    }
    
    const state = {
      fund: 'acwi',
      customRate: 5.0,
      startYear: 2014,
      startMonth: 1,
      endYear: 2024,
      endMonth: 1,
      monthlyAmount: 30000,
      broker: {
        name: 'sbi',
        cardRate: 0.5,
        holdingRate: 0.02
      }
    };

    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      await loadData();
      initializeUI();
      setupEventListeners();
      updatePricePreview(); // åˆæœŸè¡¨ç¤º
    });

    async function loadData() {
      try {
        // å¤–éƒ¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæ™‚ã¯åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«data/index_data.jsonã‚’é…ç½®
        const response = await fetch('data/index_data.json');
        if (!response.ok) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        indexData = await response.json();
        console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', indexData.metadata);
        
        // ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’ç¢ºèªã—ã¦UIã‚’æ›´æ–°
        updateUIWithDataRange();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(data/index_data.json)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }
    
    function updateUIWithDataRange() {
      if (!indexData || !indexData.data || indexData.data.length === 0) return;
      
      // ãƒ‡ãƒ¼ã‚¿ã®é–‹å§‹ãƒ»çµ‚äº†æ—¥ã‚’å–å¾—
      const startDate = new Date(indexData.data[0].date);
      const endDate = new Date(indexData.data[indexData.data.length - 1].date);
      
      const startYear = startDate.getFullYear();
      const endYear = endDate.getFullYear();
      
      // å¹´ã®é¸æŠè‚¢ã‚’æ›´æ–°
      const startYearSelect = document.getElementById('startYear');
      const endYearSelect = document.getElementById('endYear');
      
      startYearSelect.innerHTML = '';
      endYearSelect.innerHTML = '';
      
      for (let y = startYear; y <= endYear; y++) {
        startYearSelect.add(new Option(y, y));
        endYearSelect.add(new Option(y, y));
      }
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      state.startYear = startYear;
      state.startMonth = startDate.getMonth() + 1;
      state.endYear = endYear;
      state.endMonth = endDate.getMonth() + 1;
      
      startYearSelect.value = state.startYear;
      endYearSelect.value = state.endYear;
      document.getElementById('startMonth').value = state.startMonth;
      document.getElementById('endMonth').value = state.endMonth;
      
      updatePeriodBadge();
      updatePricePreview();
    }

    function initializeUI() {
      // æœˆã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const startMonthSelect = document.getElementById('startMonth');
      const endMonthSelect = document.getElementById('endMonth');
      
      for (let m = 1; m <= 12; m++) {
        startMonthSelect.add(new Option(m + 'æœˆ', m));
        endMonthSelect.add(new Option(m + 'æœˆ', m));
      }
      
      startMonthSelect.value = state.startMonth;
      endMonthSelect.value = state.endMonth;
      
      updatePeriodBadge();
    }

    function setupEventListeners() {
      // éŠ˜æŸ„é¸æŠ
      document.querySelectorAll('.fund-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.fund-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.fund = btn.dataset.fund;
          
          const customContainer = document.getElementById('customRateContainer');
          if (state.fund === 'custom') {
            customContainer.classList.add('show');
          } else {
            customContainer.classList.remove('show');
          }
          
          updatePricePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        });
      });
      
      // ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šãƒ—ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.rate-preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('customRate').value = btn.dataset.rate;
          state.customRate = parseFloat(btn.dataset.rate);
          updatePricePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        });
      });
      
      // ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šå…¥åŠ›
      document.getElementById('customRate').addEventListener('change', (e) => {
        state.customRate = parseFloat(e.target.value) || 5.0;
        updatePricePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      });
      
      // æœŸé–“é¸æŠ
      ['startYear', 'startMonth', 'endYear', 'endMonth'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
          state[id] = parseInt(e.target.value);
          updatePeriodBadge();
          updatePricePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        });
      });
      
      // é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const amount = parseInt(btn.dataset.amount);
          document.getElementById('monthlyAmount').value = amount;
          state.monthlyAmount = amount;
        });
      });
      
      // é‡‘é¡å…¥åŠ›
      document.getElementById('monthlyAmount').addEventListener('change', (e) => {
        state.monthlyAmount = parseInt(e.target.value) || 30000;
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      });
      
      // è¨¼åˆ¸ä¼šç¤¾é¸æŠ
      document.querySelectorAll('.broker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.broker-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.broker = {
            name: btn.dataset.broker,
            cardRate: parseFloat(btn.dataset.cardRate),
            holdingRate: parseFloat(btn.dataset.holdingRate)
          };
        });
      });
      
      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
      document.querySelectorAll('.history-accordion').forEach(accordion => {
        accordion.querySelector('.history-header').addEventListener('click', () => {
          accordion.classList.toggle('open');
        });
      });
      
      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      document.getElementById('simulateBtn').addEventListener('click', runSimulation);
    }

    function updatePeriodBadge() {
      const startDate = new Date(state.startYear, state.startMonth - 1);
      const endDate = new Date(state.endYear, state.endMonth - 1);
      
      let months = (endDate.getFullYear() - startDate.getFullYear()) * 12 
                   + (endDate.getMonth() - startDate.getMonth());
      
      if (months < 0) months = 0;
      
      const years = Math.floor(months / 12);
      const remainingMonths = months % 12;
      
      document.getElementById('periodBadge').textContent = 
        `ğŸ“… æŠ•è³‡æœŸé–“ï¼š${years}å¹´${remainingMonths}ãƒ¶æœˆ`;
    }

    function updatePricePreview() {
      if (!indexData) return;
      
      // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const startKey = `${state.startYear}-${String(state.startMonth).padStart(2, '0')}`;
      const endKey = `${state.endYear}-${String(state.endMonth).padStart(2, '0')}`;
      
      const periodData = indexData.data.filter(d => {
        const key = d.date.substring(0, 7);
        return key >= startKey && key <= endKey;
      });
      
      if (periodData.length < 2) {
        document.getElementById('previewStartPrice').textContent = '-';
        document.getElementById('previewEndPrice').textContent = '-';
        document.getElementById('previewChangeRate').textContent = '-';
        return;
      }
      
      // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      let prices, fundName;
      if (state.fund === 'custom') {
        prices = generateCustomPricesForPreview(periodData.length, state.customRate);
        fundName = `ã‚«ã‚¹ã‚¿ãƒ ï¼ˆå¹´åˆ©${state.customRate}%ï¼‰`;
      } else {
        prices = periodData.map(d => d[state.fund]);
        fundName = fundNames[state.fund];
      }
      
      const dates = periodData.map(d => d.date);
      const startPrice = prices[0];
      const endPrice = prices[prices.length - 1];
      const changeRate = ((endPrice / startPrice) - 1) * 100;
      
      // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      document.getElementById('previewTitle').textContent = `ğŸ“ˆ ${fundName} ä¾¡æ ¼æ¨ç§»`;
      document.getElementById('previewRange').textContent = 
        `${state.startYear}/${state.startMonth} ã€œ ${state.endYear}/${state.endMonth}`;
      
      // çµ±è¨ˆæ›´æ–°
      document.getElementById('previewStartPrice').textContent = formatPrice(startPrice);
      document.getElementById('previewEndPrice').textContent = formatPrice(endPrice);
      
      const changeRateEl = document.getElementById('previewChangeRate');
      changeRateEl.textContent = (changeRate >= 0 ? '+' : '') + changeRate.toFixed(1) + '%';
      changeRateEl.className = 'preview-stat-value ' + (changeRate >= 0 ? 'positive' : 'negative');
      
      // ã‚°ãƒ©ãƒ•æç”»
      drawPricePreviewChart(dates, prices);
    }
    
    function generateCustomPricesForPreview(months, annualRate) {
      const monthlyRate = Math.pow(1 + annualRate / 100, 1/12) - 1;
      const prices = [10000];
      
      for (let i = 1; i < months; i++) {
        prices.push(prices[i-1] * (1 + monthlyRate));
      }
      
      return prices;
    }
    
    function drawPricePreviewChart(dates, prices) {
      const ctx = document.getElementById('pricePreviewChart').getContext('2d');
      
      if (previewChart) {
        previewChart.destroy();
      }
      
      // ãƒ©ãƒ™ãƒ«ä½œæˆï¼ˆé–“å¼•ãï¼‰
      const step = Math.ceil(dates.length / 12);
      const labels = dates.map((d, i) => {
        if (i % step === 0 || i === dates.length - 1) {
          const date = new Date(d);
          return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}`;
        }
        return '';
      });
      
      // ä¸Šæ˜‡ãƒ»ä¸‹è½ã§è‰²ã‚’å¤‰ãˆã‚‹
      const startPrice = prices[0];
      const endPrice = prices[prices.length - 1];
      const isPositive = endPrice >= startPrice;
      const lineColor = isPositive ? '#4caf50' : '#f44336';
      const bgColor = isPositive ? 'rgba(76, 175, 80, 0.1)' : 'rgba(244, 67, 54, 0.1)';
      
      previewChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: prices,
            borderColor: lineColor,
            backgroundColor: bgColor,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => 'Â¥' + Math.round(ctx.raw).toLocaleString()
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                maxRotation: 0,
                font: { size: 9 },
                callback: function(val, index) {
                  const label = this.getLabelForValue(val);
                  return label || null;
                }
              }
            },
            y: {
              grid: { color: '#f0f0f0' },
              ticks: {
                callback: (val) => {
                  if (val >= 10000) {
                    return 'Â¥' + (val / 10000).toFixed(1) + 'ä¸‡';
                  } else if (val >= 1000) {
                    return 'Â¥' + (val / 1000).toFixed(1) + 'åƒ';
                  }
                  return 'Â¥' + val;
                },
                font: { size: 9 },
                maxTicksLimit: 5
              }
            }
          },
          animation: {
            duration: 500
          }
        }
      });
    }

    // ========================================
    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    function runSimulation() {
      const btn = document.getElementById('simulateBtn');
      btn.disabled = true;
      btn.innerHTML = 'â³ è¨ˆç®—ä¸­...';
      
      setTimeout(() => {
        try {
          const result = calculateSimulation();
          displayResults(result);
        } catch (error) {
          console.error('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹';
        }
      }, 100);
    }

    function calculateSimulation() {
      // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const startKey = `${state.startYear}-${String(state.startMonth).padStart(2, '0')}`;
      const endKey = `${state.endYear}-${String(state.endMonth).padStart(2, '0')}`;
      
      const periodData = indexData.data.filter(d => {
        const key = d.date.substring(0, 7);
        return key >= startKey && key <= endKey;
      });
      
      if (periodData.length < 2) {
        throw new Error('é¸æŠæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      }
      
      // æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’æœˆæ¬¡ã«å¤‰æ›ï¼ˆå„æœˆã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
      const monthlyData = [];
      let currentMonth = '';
      
      for (const d of periodData) {
        const month = d.date.substring(0, 7);
        if (month !== currentMonth) {
          monthlyData.push(d);
          currentMonth = month;
        }
      }
      
      if (monthlyData.length < 2) {
        throw new Error('é¸æŠæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      }
      
      // ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šã®å ´åˆã¯ä¾¡æ ¼ã‚’ç”Ÿæˆ
      let prices;
      if (state.fund === 'custom') {
        prices = generateCustomPrices(monthlyData.length, state.customRate);
      } else {
        prices = monthlyData.map(d => d[state.fund]);
      }
      
      const dates = monthlyData.map(d => d.date);
      
      // ä¸€æ‹¬æŠ•è³‡ã®è¨ˆç®—
      const ikkatsuResult = calculateIkkatsu(prices, dates);
      
      // ç©ç«‹æŠ•è³‡ã®è¨ˆç®—
      const tsumitateResult = calculateTsumitate(prices, dates);
      
      // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
      const pointsResult = calculatePoints(tsumitateResult);
      
      return {
        ikkatsu: ikkatsuResult,
        tsumitate: tsumitateResult,
        points: pointsResult,
        dates: dates,
        prices: prices
      };
    }

    function generateCustomPrices(months, annualRate) {
      // ã‚«ã‚¹ã‚¿ãƒ åˆ©å›ã‚Šã§ä¸€å®šæˆé•·ã™ã‚‹ä¾¡æ ¼ã‚’ç”Ÿæˆ
      const monthlyRate = Math.pow(1 + annualRate / 100, 1/12) - 1;
      const prices = [10000]; // åŸºæº–ä¾¡æ ¼
      
      for (let i = 1; i < months; i++) {
        prices.push(prices[i-1] * (1 + monthlyRate));
      }
      
      return prices;
    }

    function calculateIkkatsu(prices, dates) {
      const totalMonths = prices.length;
      const totalInvestment = state.monthlyAmount * totalMonths;
      const startPrice = prices[0];
      const endPrice = prices[prices.length - 1];
      
      // è³¼å…¥å£æ•°ï¼ˆé–‹å§‹æ™‚ã«å…¨é¡æŠ•è³‡ï¼‰
      const units = totalInvestment / startPrice;
      
      // æœ€çµ‚è©•ä¾¡é¡
      const finalValue = units * endPrice;
      
      // æœˆã”ã¨ã®è©•ä¾¡é¡æ¨ç§»
      const monthlyValues = prices.map(p => units * p);
      
      return {
        totalInvestment,
        startPrice,
        endPrice,
        units,
        finalValue,
        profit: finalValue - totalInvestment,
        profitRate: ((finalValue / totalInvestment) - 1) * 100,
        purchaseDate: dates[0],
        monthlyValues
      };
    }

    function calculateTsumitate(prices, dates) {
      const history = [];
      let totalUnits = 0;
      let totalInvestment = 0;
      const monthlyValues = [];
      
      // å¹³å‡ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰
      const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
      
      prices.forEach((price, i) => {
        const units = state.monthlyAmount / price;
        totalUnits += units;
        totalInvestment += state.monthlyAmount;
        
        const currentValue = totalUnits * price;
        monthlyValues.push(currentValue);
        
        history.push({
          date: dates[i],
          price,
          units,
          totalUnits,
          investment: state.monthlyAmount,
          totalInvestment,
          currentValue,
          isHighlight: price < avgPrice * 0.95 // å¹³å‡ã‚ˆã‚Š5%ä»¥ä¸Šå®‰ã„
        });
      });
      
      const endPrice = prices[prices.length - 1];
      const finalValue = totalUnits * endPrice;
      const avgCost = totalInvestment / totalUnits;
      
      return {
        history,
        totalInvestment,
        totalUnits,
        avgCost,
        finalValue,
        profit: finalValue - totalInvestment,
        profitRate: ((finalValue / totalInvestment) - 1) * 100,
        purchaseCount: history.length,
        monthlyValues
      };
    }

    function calculatePoints(tsumitateResult) {
      let cardPoints = 0;
      let holdingPoints = 0;
      
      tsumitateResult.history.forEach((h, i) => {
        // ã‚¯ãƒ¬ã‚«ç©ç«‹ãƒã‚¤ãƒ³ãƒˆï¼ˆæ¯æœˆã®ç©ç«‹é¡ã«å¯¾ã—ã¦ï¼‰
        cardPoints += state.monthlyAmount * (state.broker.cardRate / 100);
        
        // ä¿æœ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãã®æœˆã®è©•ä¾¡é¡ã«å¯¾ã—ã¦ã€å¹´ç‡ã‚’æœˆå‰²ã‚Šï¼‰
        holdingPoints += h.currentValue * (state.broker.holdingRate / 100 / 12);
      });
      
      return {
        cardPoints: Math.round(cardPoints),
        holdingPoints: Math.round(holdingPoints),
        totalPoints: Math.round(cardPoints + holdingPoints)
      };
    }

    // ========================================
    // çµæœè¡¨ç¤º
    // ========================================
    function displayResults(result) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.classList.add('show');
      
      // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const formatYen = (val) => Math.round(val).toLocaleString() + 'å††';
      const formatRate = (val) => (val >= 0 ? '+' : '') + val.toFixed(1) + '%';
      
      // å‹è€…åˆ¤å®š
      const tsumitateWins = result.tsumitate.finalValue > result.ikkatsu.finalValue;
      
      // ä¸€æ‹¬æŠ•è³‡ã‚«ãƒ¼ãƒ‰
      const ikkatsuCard = document.getElementById('ikkatsuCard');
      ikkatsuCard.classList.toggle('winner', !tsumitateWins);
      document.getElementById('ikkatsuAmount').textContent = formatYen(result.ikkatsu.finalValue);
      document.getElementById('ikkatsuPrincipal').textContent = 'å…ƒæœ¬ ' + formatYen(result.ikkatsu.totalInvestment);
      
      const ikkatsuDiff = document.getElementById('ikkatsuDiff');
      if (!tsumitateWins) {
        const diff = result.ikkatsu.finalValue - result.tsumitate.finalValue;
        ikkatsuDiff.textContent = 'ç©ç«‹ã‚ˆã‚Š +' + formatYen(diff);
        ikkatsuDiff.className = 'diff positive';
      } else {
        ikkatsuDiff.textContent = formatRate(result.ikkatsu.profitRate);
        ikkatsuDiff.className = 'diff';
      }
      
      // ç©ç«‹æŠ•è³‡ã‚«ãƒ¼ãƒ‰
      const tsumitateCard = document.getElementById('tsumitateCard');
      tsumitateCard.classList.toggle('winner', tsumitateWins);
      document.getElementById('tsumitateAmount').textContent = formatYen(result.tsumitate.finalValue);
      document.getElementById('tsumitatePrincipal').textContent = 'å…ƒæœ¬ ' + formatYen(result.tsumitate.totalInvestment);
      
      const tsumitateDiff = document.getElementById('tsumitateDiff');
      if (tsumitateWins) {
        const diff = result.tsumitate.finalValue - result.ikkatsu.finalValue;
        tsumitateDiff.textContent = 'ä¸€æ‹¬ã‚ˆã‚Š +' + formatYen(diff) + ' ğŸ’ª';
        tsumitateDiff.className = 'diff positive';
      } else {
        tsumitateDiff.textContent = formatRate(result.tsumitate.profitRate);
        tsumitateDiff.className = 'diff';
      }
      
      // ãƒã‚¤ãƒ³ãƒˆ
      document.getElementById('totalPoints').textContent = 
        result.points.totalPoints.toLocaleString() + ' pt';
      
      // ã‚°ãƒ©ãƒ•æç”»
      drawChart(result);
      
      // ä¸€æ‹¬æŠ•è³‡è©³ç´°
      const startDate = new Date(result.ikkatsu.purchaseDate);
      document.getElementById('ikkatsuDetail').innerHTML = `
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">è³¼å…¥æ—¥</span>
          <span class="ikkatsu-value">${startDate.getFullYear()}å¹´${startDate.getMonth()+1}æœˆ</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">æŠ•è³‡é‡‘é¡</span>
          <span class="ikkatsu-value">${formatYen(result.ikkatsu.totalInvestment)}</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">è³¼å…¥æ™‚ä¾¡æ ¼</span>
          <span class="ikkatsu-value">${formatPriceDetail(result.ikkatsu.startPrice)}</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">è³¼å…¥å£æ•°</span>
          <span class="ikkatsu-value">${result.ikkatsu.units.toFixed(4)}å£</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">çµ‚äº†æ™‚ä¾¡æ ¼</span>
          <span class="ikkatsu-value">${formatPriceDetail(result.ikkatsu.endPrice)}</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">çµ‚äº†æ™‚è©•ä¾¡é¡</span>
          <span class="ikkatsu-value">${formatYen(result.ikkatsu.finalValue)}</span>
        </div>
        <div class="ikkatsu-row">
          <span class="ikkatsu-label">æç›Š</span>
          <span class="ikkatsu-value" style="color: ${result.ikkatsu.profit >= 0 ? '#4caf50' : '#f44336'}">
            ${result.ikkatsu.profit >= 0 ? '+' : ''}${formatYen(result.ikkatsu.profit)}ï¼ˆ${formatRate(result.ikkatsu.profitRate)}ï¼‰
          </span>
        </div>
      `;
      
      // ç©ç«‹æŠ•è³‡ãƒ†ãƒ¼ãƒ–ãƒ«
      const tbody = document.getElementById('tsumitateTableBody');
      tbody.innerHTML = result.tsumitate.history.map(h => {
        const date = new Date(h.date);
        return `
          <tr class="${h.isHighlight ? 'highlight' : ''}">
            <td>${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}</td>
            <td>${formatPriceDetail(h.price)}</td>
            <td>${h.units.toFixed(4)}</td>
            <td>${h.totalUnits.toFixed(4)}</td>
          </tr>
        `;
      }).join('');
      
      // ã‚µãƒãƒªãƒ¼
      document.getElementById('avgCost').textContent = formatPriceDetail(result.tsumitate.avgCost);
      document.getElementById('totalUnits').textContent = result.tsumitate.totalUnits.toFixed(4) + 'å£';
      document.getElementById('purchaseCount').textContent = result.tsumitate.purchaseCount + 'å›';
      
      // çµæœã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function drawChart(result) {
      const ctx = document.getElementById('resultChart').getContext('2d');
      
      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      if (chart) {
        chart.destroy();
      }
      
      // ãƒ©ãƒ™ãƒ«ä½œæˆï¼ˆå¹´/æœˆå½¢å¼ï¼‰
      const labels = result.dates.map(d => {
        const date = new Date(d);
        return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}`;
      });
      
      // é–“å¼•ãï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå¤šã„å ´åˆï¼‰
      const step = Math.ceil(labels.length / 24);
      const filteredLabels = labels.filter((_, i) => i % step === 0 || i === labels.length - 1);
      const filteredTsumitate = result.tsumitate.monthlyValues.filter((_, i) => i % step === 0 || i === result.tsumitate.monthlyValues.length - 1);
      const filteredIkkatsu = result.ikkatsu.monthlyValues.filter((_, i) => i % step === 0 || i === result.ikkatsu.monthlyValues.length - 1);
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filteredLabels,
          datasets: [
            {
              label: 'ç©ç«‹æŠ•è³‡',
              data: filteredTsumitate,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              borderWidth: 2
            },
            {
              label: 'ä¸€æ‹¬æŠ•è³‡',
              data: filteredIkkatsu,
              borderColor: '#bdbdbd',
              backgroundColor: 'rgba(189, 189, 189, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': Â¥' + Math.round(ctx.raw).toLocaleString()
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                maxRotation: 45,
                font: { size: 10 }
              }
            },
            y: {
              grid: { color: '#f0f0f0' },
              ticks: {
                callback: (val) => {
                  if (val >= 100000000) {
                    return 'Â¥' + (val / 100000000).toFixed(1) + 'å„„';
                  } else if (val >= 10000) {
                    return 'Â¥' + (val / 10000).toFixed(0) + 'ä¸‡';
                  }
                  return 'Â¥' + val.toLocaleString();
                },
                font: { size: 10 }
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          }
        }
      });
    }
  </script>
</body>
</html>
